# Recover
Programme qui récupère les JPEG à partir d'une image médico-légale

En prévision de ce problème, nous avons passé les derniers jours à prendre des photos de personnes que nous connaissons, qui ont toutes été enregistrées sur un appareil photo numérique au format JPEG sur une carte mémoire. (D'accord, il est possible que nous ayons plutôt passé les derniers jours sur Facebook.) Malheureusement, nous les avons tous supprimés d'une manière ou d'une autre ! Heureusement, dans le monde informatique, « supprimé » a tendance à ne pas signifier tant « supprimé » que « oublié ». Même si l'appareil photo insiste sur le fait que la carte est maintenant vierge, nous sommes presque sûrs que ce n'est pas tout à fait vrai. En effet, nous espérons (euh, attendons !) que vous puissiez écrire un programme qui récupère les photos pour nous !

Même si les JPEG sont plus compliqués que les BMP, les JPEG ont des « signatures », des modèles d'octets qui peuvent les distinguer des autres formats de fichiers. Plus précisément, les trois premiers octets de JPEG sont

0xff 0xd8 0xff
du premier octet au troisième octet, de gauche à droite. Le quatrième octet, quant à lui, est soit 0xe0, 0xe1, 0xe2, 0xe3, 0xe4, 0xe5, 0xe6, 0xe7, 0xe8, 0xe9, 0xea, 0xeb, 0xec, 0xed, 0xee, ou 0xef. En d'autres termes, les quatre premiers bits du quatrième octet sont 1110.

Il y a de fortes chances que si vous trouvez ce motif de quatre octets sur des supports connus pour stocker des photos (par exemple, ma carte mémoire), ils délimitent le début d'un JPEG. Pour être juste, vous pouvez rencontrer ces modèles sur certains disques par hasard, donc la récupération de données n'est pas une science exacte.

Heureusement, les appareils photo numériques ont tendance à stocker les photos de manière contiguë sur des cartes mémoire, chaque photo étant stockée immédiatement après la photo prise précédemment. En conséquence, le début d'un JPEG marque généralement la fin d'un autre. Cependant, les appareils photo numériques initialisent souvent les cartes avec un système de fichiers FAT dont la « taille de bloc » est de 512 octets (B). L'implication est que ces appareils photo n'écrivent sur ces cartes que par unités de 512 B. Une photo de 1 Mo (c'est-à-dire 1 048 576 B) occupe donc 1048576 ÷ 512 = 2048 « blocs » sur une carte mémoire. Mais il en va de même pour une photo qui est, disons, un octet plus petite (c'est-à-dire 1 048 575 B) ! L'espace perdu sur le disque est appelé « espace libre ». Les enquêteurs médico-légaux recherchent souvent l'espace libre pour les restes de données suspectes.

L'implication de tous ces détails est que vous, l'enquêteur, pouvez probablement écrire un programme qui itère sur une copie de ma carte mémoire, à la recherche des signatures des JPEG. Chaque fois que vous trouvez une signature, vous pouvez ouvrir un nouveau fichier pour l'écriture et commencer à remplir ce fichier avec des octets de ma carte mémoire, en fermant ce fichier uniquement une fois que vous rencontrez une autre signature. De plus, plutôt que de lire les octets de ma carte mémoire un par un, vous pouvez en lire 512 à la fois dans un buffer pour plus d'efficacité. Grâce à FAT, vous pouvez être sûr que les signatures des JPEG seront « alignées sur les blocs ». C'est-à-dire que vous n'avez qu'à rechercher ces signatures dans les quatre premiers octets d'un bloc.

Sachez, bien sûr, que les JPEG peuvent s'étendre sur des blocs contigus. Sinon, aucun JPEG ne pourrait dépasser 512 B. Mais le dernier octet d'un JPEG pourrait ne pas tomber à la toute fin d'un bloc. Rappelez-vous la possibilité d'espace mou. Mais ne vous inquiétez pas. Étant donné que cette carte mémoire était toute neuve lorsque j'ai commencé à prendre des photos, il y a de fortes chances qu'elle ait été « remise à zéro » (c'est-à-dire remplie de 0) par le fabricant, auquel cas tout espace libre sera rempli de 0. Ce n'est pas grave si ces 0 finaux se retrouvent dans les JPEG que vous récupérez ; ils doivent toujours être visibles.

Maintenant, je n'ai qu'une seule carte mémoire, mais vous êtes nombreux ! Et donc je suis allé de l'avant et j'ai créé une "image médico-légale" de la carte, stockant son contenu, octet après octet, dans un fichier appelé card.raw. Pour que vous ne perdiez pas de temps à itérer inutilement sur des millions de 0, je n'ai imagé que les premiers mégaoctets de la carte mémoire. Mais vous devriez finalement constater que l'image contient 50 JPEG.
